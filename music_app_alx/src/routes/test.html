<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Authentication Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            background: #f4f4f4;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        button {
            background: #1db954;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1ed760;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .profile-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #avatar img {
            border-radius: 50%;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Spotify Web API Authentication Demo</h1>
    
    <div class="container">
        <h2>Authentication Status</h2>
        <div id="authStatus" class="status info">Not authenticated</div>
        
        <button id="loginBtn" onclick="startLogin()">üéµ Login with Spotify</button>
        <button id="fetchProfileBtn" onclick="fetchProfile()" disabled>üë§ Fetch Profile</button>
        <button id="logoutBtn" onclick="logout()" disabled>üö™ Logout</button>
    </div>

    <div class="container">
        <h2>Debug Information</h2>
        <div id="debugInfo"></div>
        <button onclick="showDebugInfo()">üîç Show Debug Info</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
    </div>

    <div class="container">
        <h2>Profile Information</h2>
        <div id="profileContainer" style="display: none;">
            <div class="profile-info">
                <div id="avatar"></div>
                <p><strong>Name:</strong> <span id="displayName">-</span></p>
                <p><strong>ID:</strong> <span id="id">-</span></p>
                <p><strong>Email:</strong> <span id="email">-</span></p>
                <p><strong>Spotify URI:</strong> <a id="uri" href="#" target="_blank">-</a></p>
                <p><strong>Profile URL:</strong> <a id="url" href="#" target="_blank">-</a></p>
                <p><strong>Image URL:</strong> <span id="imgUrl">-</span></p>
            </div>
        </div>
    </div>

    <script>
        // Update these with your actual values
        const clientId = "941d6389eb244304b5fc2fb75fdf4131";
        // IMPORTANT: Update this to your current ngrok URL or permanent domain
        const redirectUri = "https://a20f10140575.ngrok-free.app/music_app_alx/src/routes/test.html";
        
        let debugLogs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = '<pre>' + debugLogs.slice(-10).join('\n') + '</pre>';
        }
        
        function clearLogs() {
            debugLogs = [];
            updateDebugDisplay();
        }
        
        function showDebugInfo() {
            const params = new URLSearchParams(window.location.search);
            const hasCode = params.has('code');
            const hasError = params.has('error');
            const hasToken = !!getItem('access_token');
            const hasVerifier = !!getItem('verifier');
            
            log(`Current URL: ${window.location.href}`);
            log(`Has auth code: ${hasCode}`);
            log(`Has error: ${hasError}`);
            log(`Has access token: ${hasToken}`);
            log(`Has verifier: ${hasVerifier}`);
            log(`Redirect URI: ${redirectUri}`);
            log(`Client ID: ${clientId}`);
        }

        // Storage functions with fallback
        let memoryStorage = {};
        
        function setItem(key, value) {
            try {
                localStorage.setItem(key, value);
                log(`Stored ${key} in localStorage`);
            } catch (e) {
                memoryStorage[key] = value;
                log(`Stored ${key} in memory (localStorage failed)`);
            }
        }

        function getItem(key) {
            try {
                return localStorage.getItem(key) || memoryStorage[key];
            } catch (e) {
                return memoryStorage[key];
            }
        }

        function removeItem(key) {
            try {
                localStorage.removeItem(key);
                log(`Removed ${key} from localStorage`);
            } catch (e) {
                delete memoryStorage[key];
                log(`Removed ${key} from memory`);
            }
        }

        // Main authentication functions
        async function startLogin() {
            try {
                log('Starting Spotify login process...');
                updateAuthStatus('Starting authentication...', 'info');
                
                const verifier = generateCodeVerifier(128);
                const challenge = await generateCodeChallenge(verifier);

                log(`Generated code verifier: ${verifier.substring(0, 20)}...`);
                setItem("verifier", verifier);

                const params = new URLSearchParams();
                params.append("client_id", clientId);
                params.append("response_type", "code");
                params.append("redirect_uri", redirectUri);
                params.append("scope", "user-read-private user-read-email");
                params.append("code_challenge_method", "S256");
                params.append("code_challenge", challenge);

                const authUrl = `https://accounts.spotify.com/authorize?${params.toString()}`;
                log(`Redirecting to: ${authUrl}`);
                
                window.location.href = authUrl;
            } catch (error) {
                log(`Error starting login: ${error.message}`, 'error');
                updateAuthStatus(`Login failed: ${error.message}`, 'error');
            }
        }

        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get("code");
            const error = params.get("error");
            
            if (error) {
                log(`Spotify authorization error: ${error}`, 'error');
                updateAuthStatus(`Authorization failed: ${error}`, 'error');
                return;
            }

            if (code) {
                try {
                    log('Authorization code received, exchanging for token...');
                    updateAuthStatus('Exchanging code for access token...', 'info');
                    
                    const accessToken = await getAccessToken(clientId, code);
                    log('Access token received successfully');
                    
                    setItem("access_token", accessToken);
                    updateAuthStatus('Successfully authenticated!', 'success');
                    
                    // Clean up URL
                    window.history.replaceState({}, document.title, redirectUri);
                    removeItem("verifier");
                    
                    updateUI();
                } catch (error) {
                    log(`Token exchange failed: ${error.message}`, 'error');
                    updateAuthStatus(`Authentication failed: ${error.message}`, 'error');
                }
            }
        }

        function generateCodeVerifier(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) {
                text += possible.charAt(Math.floor(Math.random() * possible.length));
            }
            return text;
        }

        async function generateCodeChallenge(codeVerifier) {
            const data = new TextEncoder().encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function getAccessToken(clientId, code) {
            const verifier = getItem("verifier");
            
            if (!verifier) {
                throw new Error("Code verifier not found. Please restart the authentication flow.");
            }

            const params = new URLSearchParams();
            params.append("client_id", clientId);
            params.append("grant_type", "authorization_code");
            params.append("code", code);
            params.append("redirect_uri", redirectUri);
            params.append("code_verifier", verifier);

            log('Requesting access token from Spotify...');

            const result = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: params
            });

            const data = await result.json();
            log(`Token response status: ${result.status}`);

            if (!result.ok || data.error) {
                throw new Error(`${data.error || result.status}: ${data.error_description || result.statusText}`);
            }

            if (!data.access_token) {
                throw new Error("No access token received from Spotify");
            }

            return data.access_token;
        }

        async function fetchProfile() {
            try {
                const token = getItem("access_token");
                if (!token) {
                    log('No access token found', 'error');
                    alert("No access token found. Please log in first!");
                    return;
                }
                
                log('Fetching Spotify profile...');
                updateAuthStatus('Fetching profile...', 'info');
                
                const result = await fetch("https://api.spotify.com/v1/me", {
                    headers: { 
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!result.ok) {
                    const errorData = await result.json().catch(() => ({}));
                    throw new Error(`${result.status}: ${errorData.error?.message || result.statusText}`);
                }

                const profile = await result.json();
                log('Profile fetched successfully');
                populateProfile(profile);
                updateAuthStatus('Profile loaded successfully!', 'success');
                
            } catch (error) {
                log(`Profile fetch failed: ${error.message}`, 'error');
                updateAuthStatus(`Failed to fetch profile: ${error.message}`, 'error');
                
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    removeItem("access_token");
                    updateUI();
                }
            }
        }

        function populateProfile(profile) {
            document.getElementById("displayName").innerText = profile.display_name || 'N/A';
            document.getElementById("id").innerText = profile.id || 'N/A';
            document.getElementById("email").innerText = profile.email || 'N/A';
            
            const uriElement = document.getElementById("uri");
            uriElement.innerText = profile.uri || 'N/A';
            if (profile.external_urls?.spotify) {
                uriElement.setAttribute("href", profile.external_urls.spotify);
            }
            
            const urlElement = document.getElementById("url");
            urlElement.innerText = profile.href || 'N/A';
            if (profile.href) {
                urlElement.setAttribute("href", profile.href);
            }
            
            document.getElementById("imgUrl").innerText = profile.images?.[0]?.url || '(no profile image)';

            const avatarDiv = document.getElementById("avatar");
            avatarDiv.innerHTML = '';
            if (profile.images?.[0]) {
                const img = document.createElement('img');
                img.src = profile.images[0].url;
                img.alt = "Profile image";
                img.width = 150;
                img.height = 150;
                avatarDiv.appendChild(img);
            }

            document.getElementById("profileContainer").style.display = 'block';
        }

        function logout() {
            log('Logging out...');
            removeItem("access_token");
            removeItem("verifier");
            
            document.getElementById("profileContainer").style.display = 'none';
            updateAuthStatus('Logged out', 'info');
            updateUI();
        }

        function updateAuthStatus(message, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateUI() {
            const hasToken = !!getItem('access_token');
            
            document.getElementById('loginBtn').disabled = hasToken;
            document.getElementById('fetchProfileBtn').disabled = !hasToken;
            document.getElementById('logoutBtn').disabled = !hasToken;
            
            if (hasToken) {
                updateAuthStatus('Authenticated - You can now fetch your profile!', 'success');
            } else {
                updateAuthStatus('Not authenticated - Click login to start', 'info');
                document.getElementById("profileContainer").style.display = 'none';
            }
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            log('Page loaded, checking authentication status...');
            updateUI();
            
            // Check if we're returning from Spotify with an authorization code
            const params = new URLSearchParams(window.location.search);
            if (params.has('code') || params.has('error')) {
                handleCallback();
            }
            
            showDebugInfo();
        });
    </script>
</body>
</html>